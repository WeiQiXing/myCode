<template>
  <div class='ces'>
    <div id='toolbar' class='tool-bar'>
      <!-- <el-button type="button" plain id="play">开始</el-button>
      <el-button type="button" plain id="pause">暂停</el-button>
      <el-button type="button" plain id="stop">停止</el-button>
      <div style="width: 150px;">
        <select id="stopList" style="width: 100%;">
          <option selected value>&#45;&#45;选择站点&#45;&#45;</option>
        </select>
      </div> -->
      <div>
        <label style="color:#FFFFFF ">图层透明:</label>
        <input type="range" style="width: 65%" min="0" max="1" step="0.02" title="调整地上图层透明度" data-bind="value: overGroundAlpha, valueUpdate: 'input'"/>
      </div><br>
      <div>
        <label style="color:#FFFFFF ">图层开挖:</label>
        <el-button id="excavation" >进行倾斜开挖</el-button>
      </div>
      <el-button type="button" plain id="distance">测距</el-button>
      <el-button type="button" plain id="area">侧面</el-button>
      <el-button type="button" plain id="height">测高</el-button>
      <el-button type="button" plain id="clear">清除</el-button>
    </div>
    <div id='cesrec'></div>
  </div>
</template>

<script>
import $ from 'jquery'
// import '@static/Cesium/config.js'

const Cesium = window.Cesium
export default {
  name: 'CesRec',
  data () {
    return {
      'msg': {}
    }
  },
  mounted () {
    var viewer = new Cesium.Viewer('cesrec')
    viewer.imageryLayers.addImageryProvider(new Cesium.BingMapsImageryProvider({
      url: 'https://dev.virtualearth.net',
      mapStyle: Cesium.BingMapsStyle.AERIAL,
      key: 'AqgBIfrBG50dl7Ykc9nANoj5UJnIxg5YyEZu-UE7sY_sHoZT1db1jGZAalBsU73w'
    }))
    // viewer.scene.depthTestAgainstTerrain = false
    // 打开所发布三维服务下的所有图层
    var promiseUnderground = viewer.scene.open('http://www.supermapol.com/realspace/services/3D-pipe/rest/realspace')
    Cesium.when(promiseUnderground, function (layers) {
      var overGroundLayer = scene.layers.find('Config')
      // 设置图层的阴影模式
      viewer.scene.camera.setView({
        // 将经度、纬度、高度的坐标转换为笛卡尔坐标
        destination: new Cesium.Cartesian3(-2654051.707084536, 3570921.9596162816, 4570167.290651748),
        orientation: {
          heading: 2.3280,
          pitch: -0.5861,
          roll: 6.2831
        }
      })
      // var globe = viewer.scene.globe
      viewer.scene.undergroundMode = true
      viewer.scene.screenSpaceCameraController.minimumZoomDistance = -1000
      viewer.scene.terrainProvider.isCreateSkirt = false
      var viewModel = {
        overGroundAlpha: 1
      }
      Cesium.knockout.track(viewModel)
      var toobar = document.getElementById('toolbar')
      Cesium.knockout.applyBindings(viewModel, toobar)
      Cesium.knockout.getObservable(viewModel, 'overGroundAlpha').subscribe(
        function (newValue) {
          overGroundLayer.style3D.fillForeColor.alpha = parseFloat(newValue)
        }
      )
      $('#excavation').on('click', function () { // 绘制开挖区域
        var handlerPolygon = new Cesium.DrawHandler(viewer, Cesium.DrawMode.Polygon)
        handlerPolygon.activeEvt.addEventListener(function (isActive) {
          if (isActive === true) {
            viewer.enableCursorStyle = false
            viewer._element.style.cursor = ''
            $('.ces').removeClass('drawCur').addClass('drawCur')
          } else {
            viewer.enableCursorStyle = true
            $('.ces').removeClass('drawCur')
          }
        })
        handlerPolygon.movingEvt.addEventListener(function (windowPosition) {
        })
        handlerPolygon.drawEvt.addEventListener(function (result) {
          handlerPolygon.polygon.show = false
          handlerPolygon.polyline.show = false
          var polygon = result.object
          var positions = polygon.positions
          var flatPoints = []
          for (var i = 0, j = positions.length; i < j; i++) { // 获取经纬度和高度
            var position = positions[i]
            var cartographic = Cesium.Cartographic.fromCartesian(position)
            var lon = Cesium.Math.toDegrees(cartographic.longitude)
            var lat = Cesium.Math.toDegrees(cartographic.latitude)
            var height = cartographic.height
            flatPoints.push(lon)
            flatPoints.push(lat)
            flatPoints.push(height)
          }
          overGroundLayer.addExcavationRegion({ // 设置倾斜开挖参数
            position: flatPoints,
            name: 'excavation_' + Math.random()
          })
          handlerPolygon.deactivate()
        })
        handlerPolygon.activate()
      })
      /*
      var routes = new Cesium.RouteCollection(viewer.entities)
      // 添加fpf飞行文件
      var fpfUrl = './assets/niaocao.fpf'
      routes.fromFile(fpfUrl)
      var flyManager = new Cesium.FlyManager({
        scene: scene,
        routes: routes
      })
      flyManager.stopArrived.addEventListener(function (routeStop) {
        routeStop.waitTime = 1
      })
      // alert('123')
      flyManager.readyPromise.then(function () {
        // alert('456') // 没有运行到
        var currentRoute = flyManager.currentRoute
        currentRoute.isLineVisible = true
        currentRoute.isStopVisible = true
        var allStops = flyManager.getAllRouteStops()
        var menu = document.getElementById('stopList')
        for (let i = 0, j = allStops.length; i < j; i++) {
          var option = document.createElement('option')
          option.innerHTML = '站点' + (i + 1)
          option.value = allStops[i].index
          alert('站点：' + i)
          menu.appendChild(option)
        }
        $('#stopList').change(function () { // 注册站点切换事件
          flyManager && flyManager.stop()
          var index = parseInt($(this).val()) // 站点的索引
          var route = flyManager.currentRoute
          var stop = route.get(index)
          flyManager.currentStopIndex = index
          flyManager.viewToStop(stop)
        })
        $('#play').click(function () {
          flyManager && flyManager.play()
        })
        $('#pause').click(function () {
          flyManager && flyManager.pause()
        })
        $('#stop').click(function () {
          flyManager && flyManager.stop()
        })
      })
      */
    }, function (e) {
      if (viewer.cesiumWidget._showRenderLoopErrors) {
        var title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？'
        viewer.cesiumWidget.showErrorPanel(title, undefined, e)
      }
    })
    // 空间模式
    var clampMode = 0
    var handlerDis, handlerArea, handlerHeight
    handlerDis = new Cesium.MeasureHandler(viewer, Cesium.MeasureMode.Distance, clampMode)
    handlerDis.measureEvt.addEventListener(function (result) {
      let dis = Number(result.distance)
      let distance = dis > 1000 ? (dis / 1000).toFixed(2) + 'km' : dis.toFixed(2) + 'm'
      handlerDis.disLabel.text = '距离：' + distance
    })
    handlerArea = new Cesium.MeasureHandler(viewer, Cesium.MeasureMode.Area, clampMode)
    handlerArea.measureEvt.addEventListener(function (result) {
      var mj = Number(result.area)
      var area = mj > 1000000 ? (mj / 1000000).toFixed(2) + 'km²' : mj.toFixed(2) + '㎡'
      handlerArea.areaLabel.text = '面积:' + area
    })
    handlerHeight = new Cesium.MeasureHandler(viewer, Cesium.MeasureMode.DVH)
    handlerHeight.measureEvt.addEventListener(function (result) {
      var distance = result.distance > 1000 ? (result.distance / 1000).toFixed(2) + 'km' : result.distance + 'm'
      var vHeight = result.verticalHeight > 1000 ? (result.verticalHeight / 1000).toFixed(2) + 'km' : result.verticalHeight + 'm'
      var hDistance = result.horizontalDistance > 1000 ? (result.horizontalDistance / 1000).toFixed(2) + 'km' : result.horizontalDistance + 'm'
      handlerHeight.disLabel.text = '空间距离:' + distance
      handlerHeight.vLabel.text = '垂直高度:' + vHeight
      handlerHeight.hLabel.text = '水平距离:' + hDistance
    })
    $('#distance').click(function () {
      deactiveAll()
      handlerDis && handlerDis.activate()
    })
    $('#area').click(function () {
      deactiveAll()
      handlerArea && handlerArea.activate()
    })
    $('#height').click(function () {
      deactiveAll()
      handlerHeight && handlerHeight.activate()
    })
    $('#clear').click(function () {
      clearAll()
    })
    function clearAll () {
      handlerDis && handlerDis.clear()
      handlerArea && handlerArea.clear()
      handlerHeight && handlerHeight.clear()
    }
    function deactiveAll () {
      handlerDis && handlerDis.deactivate()
      handlerArea && handlerArea.deactivate()
      handlerHeight && handlerHeight.deactivate()
    }
    // 键盘控制
    var scene = viewer.scene
    var canvas = viewer.canvas
    canvas.setAttribute('tabindex', '0')
    canvas.onclock = function () {
      canvas.focus()
    }
    var ellipsoid = scene.globe.ellipsoid
    var flags = {
      looking: false,
      moveForward: false,
      moveBackward: false,
      moveUp: false,
      moveDown: false,
      moveLeft: false,
      moveRight: false
    }
    // 判断按键值
    function getFlagForKeyCode (keyCode) {
      switch (keyCode) {
        case 'W'.charCodeAt(0):
          return 'moveForward'
        case 'S'.charCodeAt(0):
          return 'moveBackward'
        case 'Q'.charCodeAt(0):
          return 'moveUp'
        case 'E'.charCodeAt(0):
          return 'moveDown'
        case 'D'.charCodeAt(0):
          return 'moveRight'
        case 'A'.charCodeAt(0):
          return 'moveLeft'
        default:
          return undefined
      }
    }
    document.addEventListener('keydown', function (e) {
      var flagName = getFlagForKeyCode(e.keyCode)
      if (typeof flagName !== 'undefined') {
        flags[flagName] = true
      }
    }, false)
    document.addEventListener('keyup', function (e) {
      var flagName = getFlagForKeyCode(e.keyCode)
      if (typeof flagName !== 'undefined') {
        flags[flagName] = false
      }
    }, false)
    viewer.clock.onTick.addEventListener(function (clock) {
      let camera = viewer.camera
      var cameraHeight = ellipsoid.cartesianToCartographic(camera.position).height
      var moveRate = cameraHeight / 100.0
      if (flags.moveForward) {
        camera.moveForward(moveRate)
      }
      if (flags.moveBackward) {
        camera.moveBackward(moveRate)
      }
      if (flags.moveUp) {
        camera.moveUp(moveRate)
      }
      if (flags.moveDown) {
        camera.moveDown(moveRate)
      }
      if (flags.moveLeft) {
        camera.moveLeft(moveRate)
      }
      if (flags.moveRight) {
        camera.moveRight(moveRate)
      }
    })
  }
}
</script>

<style scoped>
#cesrec {
  width: 100%;
  min-height: 850px;
  height: 100%;
  margin: 0;
  overflow: hidden;
  padding: 0;
}
.tool-bar {
  background-color: rgba(38, 38, 38, 0.75);
  padding: 20px 20px 10px 20px;
  color: #ffffff;
  border: 1px solid #526f82;
  position: absolute;
  left: 250px;
  top: 100px;
  z-index: 10000;
}
</style>
